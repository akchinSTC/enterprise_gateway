sudo: required
language: python

python:
    - 2.7
    - 3.4
    - 3.6

services:
    - docker

before_cache:
  # Save tagged docker images
  - >
    mkdir -p $HOME/docker && docker images -a --filter='dangling=false' --format '{{.Repository}}:{{.Tag}} {{.ID}}'
    | xargs -n 2 -t sh -c 'test -e $HOME/docker/$1.tar.gz || docker save $0 | gzip -2 > $HOME/docker/$1.tar.gz'

cache:
    bundler: true
    directories:
     - $HOME/docker
     - /home/travis/.sbt/

env:
  global:
    - ASYNC_TEST_TIMEOUT=30

before_install:
    - if [[ -d $HOME/docker ]]; then ls $HOME/docker/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load"; fi
    - mkdir -p $HOME/.sbt/launchers/1.2.1
    - curl -L -o $HOME/.sbt/launchers/1.2.1/sbt-launch.jar http://central.maven.org/maven2/org/scala-sbt/sbt-launch/1.2.1/sbt-launch-1.2.1.jar

install:
    - pip install --upgrade setuptools pip websocket-client
    - make dist enterprise-gateway-demo
    - pip install dist/*.whl coverage
    - pip freeze

script:
    - jupyter enterprisegateway --help
    - nosetests -x --process-restartworker --with-coverage --cover-package=enterprise_gateway enterprise_gateway.tests
    - make itest-yarn
    - pip uninstall -y jupyter_enterprise_gateway

after_success:
  - echo "Travis exited with ${TRAVIS_TEST_RESULT}"
  - python --version
  - pip --version
  - pip list
  - pip install codecov
  - codecov

after_failure:
  - echo "Travis exited with ${TRAVIS_TEST_RESULT}"
  - python --version
  - pip --version
  - pip list
  - docker logs itest-yarn
